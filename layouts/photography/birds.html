{{ define "main" }}
{{ $birds := .Site.Data.birds }}
<article class="gallery-page">
    <header class="gallery-header">
        <h1>{{ .Title }}</h1>
        {{ with .Description }}<p class="gallery-desc">{{ . }}</p>{{ end }}
        <p class="gallery-count">{{ $birds.total_species }} species · {{ $birds.species_with_photos }} photographed · {{ $birds.total_photos }} photos</p>
    </header>

    {{ with .Content }}<div class="gallery-intro">{{ . }}</div>{{ end }}

    <!-- Featured Gallery — Top 10, 1 per species → links to species pages -->
    <h2 class="birds-section-title">Best Shots</h2>
    <div class="featured-grid">
        {{ range $birds.featured }}
        <a href="/photography/birds/{{ .species | urlize }}/" class="featured-item">
            <div class="featured-img-wrap">
                <img src="/img/photography/birds/{{ .file }}" alt="{{ .species }}" loading="lazy">
            </div>
            <div class="featured-caption">
                <strong>{{ .species }}</strong>
                {{ with .caption }}<p>{{ . }}</p>{{ end }}
            </div>
        </a>
        {{ end }}
    </div>

    <!-- Life List -->
    <h2 class="birds-section-title" id="lifelist">Life List</h2>
    <p class="lifelist-intro">{{ $birds.total_species }} species spotted, {{ $birds.species_with_photos }} photographed so far. Click column headers to sort. Click a species to see all photos.</p>
    <div class="catalog-wrapper">
        <table class="catalog-table lifelist-table" id="lifelist-table">
            <thead>
                <tr>
                    <th data-sort="number" class="sortable">#</th>
                    <th data-sort="species" class="sortable">Species</th>
                    <th data-sort="scientific" class="sortable">Scientific Name</th>
                    <th data-sort="date" class="sortable">First Seen</th>
                    <th data-sort="location" class="sortable">Location</th>
                    <th data-sort="photos" class="sortable sort-active sort-desc">Photos</th>
                </tr>
            </thead>
            <tbody>
                {{ range $birds.lifelist }}
                <tr data-number="{{ .number }}" data-species="{{ .species }}" data-scientific="{{ .scientific_name }}" data-date="{{ .first_seen }}" data-location="{{ .location }}" data-photos="{{ len .photos }}">
                    <td>{{ .number }}</td>
                    <td>{{ if .photos }}<a href="/photography/birds/{{ .slug }}/"><strong>{{ .species }}</strong></a>{{ else }}<span>{{ .species }}</span>{{ end }}</td>
                    <td><em>{{ .scientific_name }}</em></td>
                    <td>{{ .first_seen }}</td>
                    <td>{{ with .location }}{{ . }}{{ else }}<span class="text-muted">—</span>{{ end }}</td>
                    <td>{{ len .photos }}</td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>
</article>

<script>
(function() {
    var table = document.getElementById('lifelist-table');
    if (!table) return;
    var headers = table.querySelectorAll('th.sortable');
    var tbody = table.querySelector('tbody');
    function sortTable(key, dir) {
        var rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort(function(a, b) {
            var aVal = a.dataset[key] || '';
            var bVal = b.dataset[key] || '';
            if (key === 'number' || key === 'photos') return dir === 'asc' ? parseInt(aVal) - parseInt(bVal) : parseInt(bVal) - parseInt(aVal);
            return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }
    headers.forEach(function(header) {
        header.addEventListener('click', function() {
            var key = header.dataset.sort;
            var isAsc = header.classList.contains('sort-asc');
            var newDir = isAsc ? 'desc' : 'asc';
            headers.forEach(function(h) { h.classList.remove('sort-active', 'sort-asc', 'sort-desc'); });
            header.classList.add('sort-active', 'sort-' + newDir);
            sortTable(key, newDir);
        });
    });
    // Initial sort: photos descending
    sortTable('photos', 'desc');
})();
</script>
{{ end }}
